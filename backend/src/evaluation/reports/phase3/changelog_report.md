# Phase 3 변경점 및 비교 보고서

## 개요

Phase 3는 **프롬프트 엔지니어링 최적화**를 통해 이메일 분류 성능을 크게 개선한 버전입니다.

기존 Phase 3 초기 버전에서 복잡한 프롬프트로 인해 성능이 하락하는 문제가 있었고, 이를 **Phase 3-Lite**로 간소화하여 최적의 성능을 달성했습니다.

---

## Phase 비교 요약

### 전체 점수 비교

| Phase | 평균 점수 | Phase 1 대비 |
|-------|----------|-------------|
| **Phase 1** (Baseline) | 79.4 | - |
| **Phase 2** (RAG 추가) | 80.0 | +0.6 (+0.8%) |
| **Phase 3** (Prompt Eng.) | **95.0** | **+15.6 (+19.6%)** |

```
Phase 1  ████████████████░░░░░░░░░ 79.4
Phase 2  ████████████████░░░░░░░░░ 80.0
Phase 3  ████████████████████████░ 95.0
         ─────────────────────────
         0        50        100
```

### 항목별 점수 비교 (25점 만점)

| 항목 | Phase 1 | Phase 2 | Phase 3 | 개선폭 |
|------|---------|---------|---------|--------|
| email_type | 15 (60%) | 18 (72%) | **23 (92%)** | +8 |
| importance | 16.4 (66%) | 16 (64%) | **24 (96%)** | +7.6 |
| needs_reply | 24 (96%) | 23 (92%) | **25 (100%)** | +1 |
| sentiment | 24 (96%) | 23 (92%) | **23 (92%)** | -1 |

---

## 주요 변경사항

### 1. 프롬프트 간소화 (Lite 버전)

**Before (복잡한 Phase 3)**
```
- 4단계 Chain-of-Thought (CoT) 가이드
- Negative Examples (오분류 방지 예시)
- 3개 Few-shot 예시
- 상세한 판단 근거 요청
→ 프롬프트 길이: ~2000 토큰
→ 결과: 77.6점 (오히려 하락)
```

**After (Lite 버전)**
```
- CoT 가이드 제거
- Negative Examples 제거
- 2개 Few-shot 예시로 축소
- 핵심 분류 기준만 유지
→ 프롬프트 길이: ~800 토큰
→ 결과: 95점
```

### 2. 자동 알림 감지 시스템

배송/결제/인증 관련 자동 발송 메일을 정확히 분류하기 위한 패턴 감지 추가:

```python
AUTO_NOTIFICATION_PATTERNS = [
    "배송", "택배", "발송완료",    # 배송
    "결제", "승인", "거래",        # 금융
    "인증", "인증번호",            # 인증
    "비밀번호", "로그인"           # 계정
]
```

**효과**: "기타" 카테고리 정확도 60% → 100%

### 3. 중요도 기준 재정의

**Before (4단계)**
```
낮음(1-3) / 보통(4-6) / 높음(7-8) / 긴급(9-10)
```

**After (5단계)**
```
매우낮음(1-2): 자동 알림, 스팸
낮음(3-4): 정보성 안내
보통(5-6): 일반 업무
높음(7-8): 답변/조치 필요
긴급(9-10): 즉시 대응
```

**효과**: 중요도 정확도 64% → 96%

### 4. 분류 기준 명확화

```markdown
## 이메일 유형 분류 기준

- **채용**: 면접, 입사, 채용, 이력서 관련
- **마케팅**: 할인, 프로모션, 광고, 뉴스레터
- **공지**: 조직 전체 대상 공식 안내
- **개인**: 특정인에게 보내는 요청, 문의, 협의
- **기타**: 자동 알림, 시스템 알림, 위 4개 해당 안 됨
```

---

## Phase별 기술 구성

| 구성 요소 | Phase 1 | Phase 2 | Phase 3 |
|-----------|---------|---------|---------|
| 기본 LLM | O | O | O |
| RAG (벡터 검색) | X | O | O |
| Few-shot 예시 | X | O (3개) | O (2개) |
| 자동 알림 감지 | X | X | O |
| 5단계 중요도 | X | X | O |
| 프롬프트 최적화 | X | X | O |

---

## 문제 해결 히스토리

### 문제 1: 복잡한 프롬프트로 인한 성능 하락

**증상**: Phase 3 초기 버전 77.6점 (Phase 2보다 낮음)

**원인 분석**:
- Chain-of-Thought가 LLM을 과도하게 제약
- Negative Examples가 오히려 혼란 유발
- 프롬프트가 너무 길어 핵심 정보 희석

**해결**: Lite 버전으로 간소화

### 문제 2: "기타" 카테고리 오분류

**증상**: 택배/결제 알림이 "공지"로 분류됨

**원인 분석**:
- "알림", "안내" 키워드가 공지와 중복
- 자동 발송 메일 특성 미반영

**해결**: `AUTO_NOTIFICATION_PATTERNS` 패턴 매칭 추가

### 문제 3: 중요도 과대평가

**증상**: 대부분의 중요도가 7-10점 범위

**원인 분석**:
- 4단계 중요도 기준이 낮은 점수 설명 부족
- "매우 낮음" 케이스에 대한 가이드 없음

**해결**: 5단계 중요도로 세분화, "매우 낮음(1-2)" 명시

---

## 성능 개선 분석

### 카테고리별 개선

```
           Phase 1    Phase 3    개선
채용        80%   →    100%     +20%p
마케팅      60%   →     80%     +20%p
공지        80%   →    100%     +20%p
개인        40%   →     80%     +40%p
기타        60%   →    100%     +40%p
```

### 가장 큰 개선 케이스

| 이메일 | Phase 1 | Phase 3 | 개선 원인 |
|--------|---------|---------|----------|
| 택배 배송 완료 | 50 | 100 | 자동 알림 감지 |
| 카드 사용 알림 | 50 | 100 | 자동 알림 감지 |
| 비밀번호 변경 | 50 | 100 | 자동 알림 감지 |
| 긴급 보안 업데이트 | 75 | 100 | 중요도 기준 명확화 |

---

## 시스템 아키텍처

```
┌──────────────────────────────────────────────────────┐
│                    Phase 3 시스템                     │
├──────────────────────────────────────────────────────┤
│                                                      │
│  ┌──────────────┐    ┌──────────────┐              │
│  │ 1. 패턴 분석  │    │ 2. RAG 검색  │              │
│  │ - 자동 알림   │    │ - 유사 이메일 │              │
│  │ - 발신자 패턴 │    │ - Few-shot   │              │
│  └──────┬───────┘    └──────┬───────┘              │
│         │                   │                       │
│         └─────────┬─────────┘                       │
│                   ▼                                 │
│         ┌──────────────────┐                       │
│         │ 3. 프롬프트 생성  │                       │
│         │ - 분류 기준       │                       │
│         │ - 중요도 가이드   │                       │
│         │ - 컨텍스트 힌트   │                       │
│         └────────┬─────────┘                       │
│                  ▼                                  │
│         ┌──────────────────┐                       │
│         │  4. LLM 분석     │                       │
│         │  (Gemini)        │                       │
│         └────────┬─────────┘                       │
│                  ▼                                  │
│         ┌──────────────────┐                       │
│         │ 5. 결과 반환     │                       │
│         │ - email_type     │                       │
│         │ - importance     │                       │
│         │ - needs_reply    │                       │
│         │ - sentiment      │                       │
│         └──────────────────┘                       │
│                                                      │
└──────────────────────────────────────────────────────┘
```

---

## 결론

### 핵심 교훈

1. **프롬프트는 간결할수록 좋다**
   - 복잡한 가이드라인이 오히려 성능 저하 유발
   - 핵심 정보만 명확하게 전달

2. **규칙 기반 + LLM 하이브리드가 효과적**
   - 패턴 매칭으로 명확한 케이스 처리
   - LLM은 판단이 필요한 케이스에 집중

3. **중요도 기준은 세분화가 필요**
   - 낮은 점수 영역에 대한 명확한 가이드 필수
   - 자동 알림 = 매우 낮음 명시

### 최종 성과

```
┌─────────────────────────────────────────┐
│   Phase 1 → Phase 3 성능 향상           │
│                                         │
│   79.4점 → 95.0점 (+15.6점, +19.6%)    │
│                                         │
│   등급: C+ → A+                         │
└─────────────────────────────────────────┘
```

---

*Generated at 2025-12-09*
